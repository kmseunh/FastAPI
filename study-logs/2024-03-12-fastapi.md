# Path Parameters, Query Parameters

_2024.03.11_

#### 1. Path Parameters

파이썬의 포맷 문자열 리터럴에서 사용되는 문법을 이용하여 경로 `"매개변수"` 또는 `"변수"`를 선언할 수 있다.

```py
from fastapi import FastAPI

# FastAPI 클래스의 인스턴스 생성
app = FastAPI()


@app.get('/items/{item_id}') # {item_id}는 경로 매개변수
async def read_item(item_id)
    return {"item_id": item_id} # 현재 요청에서 받은 item_id를 포함하는 JSON 객체 반환

# http://127.0.0.1:8000/items/car 실행결과
{
"item_id": "car"
}
```

1. 타입이 있는 매개변수

```py
# 파이썬 표준 타입 어노테이션을 사용하여 함수에 있는 경로 매개변수의 타입을 선언할 수 있다.
from fastapi import FastAPI

app = FastAPI()

@app.get("/items/{item_id}")
async def read_item(item_id: int): # item_id 매개변수의 타입은 int로 지정
    return {"item_id": item_id}

# http://127.0.0.1:8000/items/2 실행결과
{
"item_id": 2
}

# http://127.0.0.1:8000/items/car 실행결과
{
    "detail": [
        {
            "type": "int_parsing",
            "loc": [
                "path",
                "item_id"
            ],
            "msg": "Input should be a valid integer, unable to parse string as an integer",
            "input": "car",
            "url": "https://errors.pydantic.dev/2.6/v/int_parsing"
        }
    ]
}
```

2. 순서 문제
경로 작동이 순차적으로 실행되기 때문에 정확한 경로 매칭을 위해 경로를 올바르게 정의해야 한다.

```py
from fastapi import FastAPI

app = FastAPI()


# 현재 사용자의 데이터를 가져오는 엔드포인트
@app.get("/users/me")
async def read_user_me():
    return {"user_id": "the current user"}

# 특정 사용자의 데이터를 가져오는 엔드포인트
@app.get("/users/{user_id}")
async def read_user(user_id: str):
    return {"user_id": user_id}

#  순서가 바뀌면 /users/{user_id} 경로가 /users/me 요청으로 해석될 수 있다.
```

3. 사전정의 값
경로 매개변수로 가능한 값들을 미리 정의하고 싶다면 Enum을 사용할 수 있다.

```py
from enum import Enum

from fastapi import FastAPI


# Enum 클래스 정의
class ModelName(str, Enum):
    alexnet = "alexnet"
    resnet = "resnet"
    lenet = "lenet"


app = FastAPI()


# /models/{model_name} 엔드포인트를 정의하고, model_name 매개변수를 사용한다.
@app.get("/models/{model_name}")
async def get_model(model_name: ModelName): 
    if model_name is ModelName.alexnet:
        return {"model_name": model_name, "message": "Deep Learning FTW!"}

    if model_name.value == "lenet":
        return {"model_name": model_name, "message": "LeCNN all the images"}

    return {"model_name": model_name, "message": "Have some residuals"}

# http://127.0.0.1:8000/models/alexnet 실행결과
{
  "model_name": "alexnet",
  "message": "Deep Learning FTW!"
}
```

4. 경로를 포함하는 경로 매개변수
`Starlette`의 옵션을 직접 이용하여 다음과 같은 `URL`을 사용함으로써 `path`를 포함하는 경로 매개변수를 선언할 수 있다.

```py
from fastapi import FastAPI

app = FastAPI()

# 매개변수의 이름은 file_path이며, 마지막 부분 :path는 매개변수가 경로와 일치해야 한다.
@app.get("/files/{file_path:path}")
async def read_file(file_path: str):
    return {"file_path": file_path}
```

#### 2. Query Parameters

경로 매개변수의 일부가 아닌 다른 함수 매개변수를 선언하면 `"쿼리"` 매개변수로 자동 해석한다.

```py
from fastapi import FastAPI

app = FastAPI()


# 임시 데이터베이스
fake_items_db = [{"item_name": "Foo"}, {"item_name": "Bar"}, {"item_name": "Baz"}]


# skip과 limit라는 두 개의 쿼리 매개변수를 받는다.
@app.get("/items/")
async def read_item(skip: int = 0, limit: int = 10): # skip은 목록에서 건너뛸 항목의 수, limit은 반환할 항목의 최대 수
    return fake_items_db[skip : skip + limit]
```

1. 기본값
쿼리 매개변수는 경로에서 고정된 부분이 아니기 때문에 선택적일 수 있고 기본값을 가질 수 있다.

    - `skip=0`과 `limit=10`은 기본값

```bash
# 다음 URL로 이동하는 것은
http://127.0.0.1:8000/items/

# 아래로 이동하는 것과 같다.
http://127.0.0.1:8000/items/?skip=0&limit=10

# 다음 URL로 이동한 경우
http://127.0.0.1:8000/items/?skip=20

# 함수의 매개변수 값은 
# skip=20: URL에서 지정했기 때문
# limit=10: 기본값이기 때문
```

2. 선택적 매개변수
기본값을 `None`으로 설정하여 선택적 매개변수를 선언할 수 있다.

```py
from typing import Union

from fastapi import FastAPI

app = FastAPI()


# q는 선택적인 쿼리 매개변수로, 문자열 또는 None일 수 있다. 
@app.get("/items/{item_id}")
async def read_item(item_id: str, q: Union[str, None] = None):
    if q:
        return {"item_id": item_id, "q": q}
    return {"item_id": item_id}
```

3. 쿼리 매개변수 형변환
`bool` 형으로 선언할 수도 있다.

```py
from typing import Union

from fastapi import FastAPI

app = FastAPI()


# short는 선택적인 bool 타입의 쿼리 매개변수, 기본값은 False
@app.get("/items/{item_id}")
async def read_item(item_id: str, q: Union[str, None] = None, short: bool = False):
    item = {"item_id": item_id}
    if q:
        item.update({"q": q})
    if not short: # 쿼리 매개변수 short가 False로 설정된 경우에만 실행
        item.update(
            {"description": "This is an amazing item that has a long description"}
        )
    return item
```

4. 여러 경로/쿼리 매개변수
여러 경로 매개변수와 쿼리 매개변수를 동시에 선언할 수 있고, 특정 순서로 선언할 필요가 없다.

```py
from typing import Union

from fastapi import FastAPI


app = FastAPI()

@app.get("/users/{user_id}/items/{item_id}")
async def read_user_item(
    user_id: int,                 # 사용자 ID (int 타입)
    item_id: str,                 # 항목 ID (str 타입)
    q: Union[str, None] = None,   # 선택적 검색 쿼리 (문자열 또는 None)
    short: bool = False           # 간단한 설명 옵션 (기본값은 False)
):
    # 항목 딕셔너리를 생성하고, 항목 ID와 소유자 ID를 추가한다.
    item = {"item_id": item_id, "owner_id": user_id}
    
    # 검색 쿼리가 제공된 경우 항목 딕셔너리에 추가합니다.
    if q:
        item.update({"q": q})
    if not short:
        item.update(
            {"description": "This is an amazing item that has a long description"}
        )
    return item
```

5. 필수 쿼리 매개변수
쿼리 매개변수를 필수로 만들려면 기본값을 선언하지 않는다.

```py
from fastapi import FastAPI

app = FastAPI()


# item_id와 needy를 받아서 항목을 반환합니다.
@app.get("/items/{item_id}")
async def read_user_item(item_id: str, needy: str):
    # item 딕셔너리를 생성, item_id와 needy 값 포함
    item = {"item_id": item_id, "needy": needy}
    return item

# http://127.0.0.1:8000/items/car 실행결과
# 필수 매개변수 needy를 넣지 않았기 때문애 Error
{
    "detail": [
        {
            "type": "missing",
            "loc": ["query", "needy"],
            "msg": "Field required",
            "input": null,
            "url": "https://errors.pydantic.dev/2.6/v/missing",
        }
    ]
}
```
