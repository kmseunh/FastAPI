# PostgreSQL DB 연동

_2024.03.17_

#### 1. PostgreSQL DB 연동

`FastAPI`는 데이터베이스와의 상호 작용을 쉽게 할 수 있도록 `SQLAlchemy`를 지원한다. `SQLAlchemy`는 다양한 데이터베이스 엔진과 상호 작용할 수 있는 `ORM(Object-Relational Mapping)` 라이브러리로, `PostgreSQL`과의 연결을 용이하게 할 수 있다.

1. `SQLAlchemy` 설치
`Python` 패키지 관리자인 `pip`를 사용하여 `SQLAlchemy` 라이브러리를 설치한다.

```bash
pip install sqlalchemy
```

2. `database.py` 생성
`SQLAlchemy`를 사용하여 데이터베이스와 상호 작용하는 데 필요한 기본적인 구성 요소를 설정한다.

```py
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# PostgreSQL 데이터베이스 연결 정보를 포함한 URL을 정의한다.
SQLALCHEMY_DATABASE_URL = (
    "postgresql://{server_username}:{server_password}@localhost:5432/{database_name}"
)

# create_engine 함수를 사용하여 데이터베이스 엔진 생성.
# connect_args={"check_same_thread": False}는 SQLite의 경우에만 필요한 옵션.
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False}
)

# 세션 생성을 위한 sessionmaker 생성.
# autocommit=False는 자동 커밋을 비활성화하여 트랜잭션 제어를 위해 사용됨.
# autoflush=False는 영속성 관리를 위해 사용됨. 
# bind 매개변수는 위에서 생성한 엔진을 사용하도록 세션을 바인딩함.
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# 데이터베이스 모델을 위한 기본 클래스를 생성.
Base = declarative_base()
```

3. `model.py` 생성
이전에 생성한 이 기본 클래스를 사용하여 `SQLAlchemy` 모델을 생성한다.

> `SQLAlchemy`는 "모델"이라는 용어를 사용하여 데이터베이스와 상호 작용하는 이러한 클래스 및 인스턴스를 나타낸다.

```py
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship

from database import Base


class Question(Base):
    __tablename__ = "question"

    id = Column(Integer, primary_key=True)
    subject = Column(String, nullable=False)
    content = Column(Text, nullable=False)
    create_date = Column(DateTime, nullable=False)


class Answer(Base):
    __tablename__ = "answer"

    id = Column(Integer, primary_key=True)
    content = Column(Text, nullable=False)
    create_date = Column(DateTime, nullable=False)
    question_id = Column(Integer, ForeignKey("question.id"))
    question = relationship("Question", backref="answers")
```

4. `schemas.py` 생성
`SQLAlchemy` 모델 과 `Pydantic` 모델 간의 혼동을 피하기 위해 `SQLAlchemy` 모델 이 있는 파일 `models.py`과 `Pydantic` 모델이 있는 파일 `schemas.py`이 있습니다.
이 `Pydantic` 모델은 `"스키마"`(유효한 데이터 모양)를 어느 정도 정의한다.
따라서 둘 다 사용하는 동안 혼동을 피하는 데 도움이 된다.

```py
from pydantic import BaseModel
from datetime import datetime
from typing import List


# 질문에 대한 기본 정보를 나타내는 Pydantic 모델
class QuestionBase(BaseModel):
    subject: str  # 질문 주제
    content: str  # 질문 내용


# 질문 생성 시에 사용되는 Pydantic 모델
class QuestionCreate(QuestionBase):
    pass


# 질문에 대한 상세 정보를 나타내는 Pydantic 모델
class Question(QuestionBase):
    id: int  # 질문의 고유 식별자
    create_date: datetime  # 질문이 생성된 날짜 및 시간

    class Config:
        orm_mode = True  # SQLAlchemy 모델과 호환되도록 설정


# 답변에 대한 기본 정보를 나타내는 Pydantic 모델
class AnswerBase(BaseModel):
    content: str  # 답변 내용


# 답변 생성 시에 사용되는 Pydantic 모델
class AnswerCreate(AnswerBase):
    pass


# 답변에 대한 상세 정보를 나타내는 Pydantic 모델
class Answer(AnswerBase):
    id: int  # 답변의 고유 식별자
    create_date: datetime  # 답변이 생성된 날짜 및 시간
    question_id: int  # 해당 답변이 속한 질문의 고유 식별자

    class Config:
        orm_mode = True  # SQLAlchemy 모델과 호환되도록 설정


# 답변과 함께 질문에 대한 상세 정보를 나타내는 Pydantic 모델
class QuestionWithAnswers(Question):
    answers: List[Answer] = []  # 질문에 대한 답변 목록

    class Config:
        orm_mode = True  # SQLAlchemy 모델과 호환되도록 설정
```
