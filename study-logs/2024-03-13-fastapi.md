# Request Body, 매개변수 검증

_2024.03.13_

#### 1. Request Body

클라이언트(브라우저)로부터 API로 데이터를 보내야 할 때, `Request Body`로 보낸다.

- `Request Body`: 클라이언트에서 API로 보내지는 데이터
- `Response Body`: API가 클라이언트로 보내는 데이터

1. 모델 사용하기
함수 안에서 모델 객체의 모든 `Attribute`에 직접 접근 가능하다.

```py
from fastapi import FastAPI
from pydantic import BaseModel


class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


app = FastAPI()


@app.post("/items/")
async def create_item(item: Item):
    item_dict = item.dict() # Item 객체를 딕셔너리로 변환
    # Item 객체에 세금 정보가 있다면,
    if item.tax:
        price_with_tax = item.price + item.tax
        # 딕셔너리에 "price_with_tax" 키와 함께 해당 값을 업데이트
        item_dict.update({"price_with_tax": price_with_tax})
    return item_dict
```

3. 요청 본문 + 경로 매개변수
경로 매개변수와 요청 본문을 동시에 선언할 수 있다.

```py
from fastapi import FastAPI
from pydantic import BaseModel


class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


app = FastAPI()

# "/items/{item_id}" 경로에 대한 HTTP PUT 요청 라우트
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Item):
    # item_id와 Item 객체의 내용을 포함한 딕셔너리를 구성하여 반환
    return {"item_id": item_id, **item.dict()}


## 요청 본문 + 경로 + 쿼리 매개변수
# item_id, Item 객체, 그리고 선택적으로 q 문자열을 매개변수로 받음
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Item, q: str | None = None):
    result = {"item_id": item_id, **item.dict()}
    # q 매개변수가 주어진 경우, 딕셔너리에 "q" 키와 함께 해당 값을 추가
    if q:
        result.update({"q": q})
    return result

# 본문, 경로 그리고 쿼리 매개변수 모두 동시에 선언할 수도 있다.
```

#### 쿼리 매개변수와 문자열 검증

`FastAPI`는 매개변수에 대한 추가 정보 및 검증을 선언할 수 있다.

```py
from typing import Union

from fastapi import FastAPI

app = FastAPI()


# 쿼리 매개변수 q는 Optional[str] 자료형이기 때문에 None이 될 수 있음
@app.get("/items/")
async def read_items(q: Union[str, None] = None):
    # 결과 딕셔너리 초기화.
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    if q:
        results.update({"q": q})
    return results


## 추가 검증
# `q`가 선택적이지만 값이 주어질 때마다 값이 50 글자를 초과하지 않게 강제한 경우
from fastapi import FastAPI, Query

@app.get("/items/")
async def read_items(q: Union[str, None] = Query(default=None, max_length=50)):
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    if q:
        results.update({"q": q})
    return results

# 기본값 None을 Query(None)으로 바꿔야 하므로, 
# Query의 첫 번째 매개변수는 기본값을 정의하는 것과 같은 목적으로 사용된다.


## 매개변수 `min_length` 추가
@app.get("/items/")
async def read_items(
    q: Union[str, None] = Query(default=None, min_length=3, max_length=50)
):
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    if q:
        results.update({"q": q})
    return results


## 매개변수와 일치해야 하는 정규표현식 정의
@app.get("/items/")
async def read_items(
    q: Union[str, None] = Query(
        default=None, min_length=3, max_length=50, pattern="^fixedquery$"
    ),
):
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    if q:
        results.update({"q": q})
    return results


## 기본값
# 기본값으로 사용하는 첫 번째 인자로 `None`을 전달하듯이, 다른 값을 전달할 수 있다.
# min_length가 3이고, 기본값이 "fixedquery"인 쿼리 매개변수 q를 선언한 경우
@app.get("/items/")
async def read_items(q: str = Query(default="fixedquery", min_length=3)):
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    
    if q:
        results.update({"q": q})
    
    return results


## Query를 필수값으로 만들어야 할 때, 첫 번째 인자로 ...를 사용할 수 있다.
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/items/")
async def read_items(q: str = Query(..., min_length=3)):
    results = {"items": [{"item_id": "Foo"}, {"item_id": "Bar"}]}
    
    if q:
        results.update({"q": q})
    
    return results
```

1. 쿼리 매개변수 리스트 / 다중값
쿼리 매개변수를 `Query`와 함께 명시적으로 선언할 때, 값들의 리스트나 다른 방법으로 여러 값을 받도록 선언 할 수도 있다.

```py
from typing import List, Union

from fastapi import FastAPI, Query

app = FastAPI()


# 매개변수의 기본값은 None, 리스트 형식의 문자열이나 None을 허용
@app.get("/items/")
async def read_items(q: Union[List[str], None] = Query(default=None)):
    query_items = {"q": q}
    return query_items

# http://localhost:8000/items/?q=foo&q=bar URL 사용

# 기본값을 사용하는 경우
from typing import List

from fastapi import FastAPI, Query

app = FastAPI()


# 매개변수의 기본값은 ["foo", "bar"]로 지정되어 있으며, 문자열 리스트를 입력으로 받는다.
@app.get("/items/")
async def read_items(q: List[str] = Query(default=["foo", "bar"])):
    query_items = {"q": q}
    return query_items

# List[str] 대신 list를 직접 사용할 수도 있다.
```

> 매개변수를 사용하는 클라이언트가 있기 때문에 한동안은 남겨둬야 하지만, 사용되지 않는다(`deprecated`)고 확실하게 문서에서 보여주고 싶다면 `deprecated=True` 매개변수를 `Query`로 전달한다.

#### 경로 매개변수와 숫자 검증

`Query`를 사용하여 쿼리 매개변수를 검증하는 방법과 동일하게 `Path`를 사용하여 경로 매개변수에 검증할 수 있다.

```py
# Import path
from typing import Union

from fastapi import FastAPI, Path, Query

app = FastAPI()


@app.get("/items/{item_id}")
async def read_items(
    # title 메타데이터 값을 경로 매개변수 item_id에 선언
    item_id: int = Path(title="The ID of the item to get"),
    q: Union[str, None] = Query(default=None, alias="item-query"),
):
    results = {"item_id": item_id}
    if q:
        results.update({"q": q})
    return results

# 경로 매개변수는 경로의 일부이기 때문에 항상 필수적
# `...`을 사용하여 필수임을 명시
item_id: int = Path(..., title="The ID of the item to get"),
```

1. 필요한 경우 매개변수 정렬하기
`FastAPI`에서는 매개변수의 순서가 중요하지 않으며, 이름, 타입 및 선언구에 따라 매개변수를 인식한다.

> 매개변수들을 재정렬함으로써 기본값(쿼리 매개변수 `q`)이 없는 값을 처음 부분에 위치 할 수 있다.

```py
from fastapi import FastAPI, Path

app = FastAPI()


# 기본값이 없는 q가 처음 부분에 위치
@app.get("/items/{item_id}")
async def read_items(q: str, item_id: int = Path(title="The ID of the item to get")):
    results = {"item_id": item_id}
    if q:
        results.update({"q": q})
    return results

# 트릭
from fastapi import FastAPI, Path

app = FastAPI()


# *를 함수의 첫 번째 매개변수로 전달하여 경로 매개변수를 정의
@app.get("/items/{item_id}")
async def read_items(*, item_id: int = Path(title="The ID of the item to get"), q: str):
    results = {"item_id": item_id}
    if q:
        results.update({"q": q})
    return results
```

2. 숫자 검증
`Query`와 `Path` 등을 사용하여 문자열 뿐만 아니라 숫자의 제약을 선언할 수 있다.

```py
# 크거나 같음
from fastapi import FastAPI, Path

app = FastAPI()


# ge=1인 경우, item_id는 1보다 "크거나(greater) 같은(equal)" 정수형 숫자여야 함
@app.get("/items/{item_id}")
async def read_items(
    *, item_id: int = Path(title="The ID of the item to get", ge=1), q: str
):
    results = {"item_id": item_id}
    if q:
        results.update({"q": q})
    return results

# 크거나 같음 및 작거나 같음
from fastapi import FastAPI, Path

app = FastAPI()


# gt=0, le=1000인 경우, item_id는 10보다 "크거나(greater than), 1000보다 작거나 같은(less than or equal)" 정수형 숫자여야 함
@app.get("/items/{item_id}")
async def read_items(
    *,
    item_id: int = Path(title="The ID of the item to get", gt=0, le=1000),
    q: str,
):
    results = {"item_id": item_id}
    if q:
        results.update({"q": q})
    return results

# 부동소수, 크거나 및 작거나
from fastapi import FastAPI, Path, Query

app = FastAPI()


@app.get("/items/{item_id}")
async def read_items(
    *,
    item_id: int = Path(title="The ID of the item to get", ge=0, le=1000),
    q: str,
    # gt=0, lt=10.5인 경우, size는 0보다 "크거나(greater than), 10.5보다 작은(less than)" 실수형 숫자여야 함
    size: float = Query(gt=0, lt=10.5),
):
    results = {"item_id": item_id}
    if q:
        results.update({"q": q})
    return results
```
